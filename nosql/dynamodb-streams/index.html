<!DOCTYPE html>
<html lang="en-us"><head>
  <!-- Basic Page Needs -->
  <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  
  <meta name="description" content="2cloudlab是云计算解决方案提供商，致力于云计算和DEVOPS。我们渴望通过云计算技术来帮助企业进行数字化转型。提高企业的研发效率、降低企业的研发成本以及加快企业的创新速度是我们成立的初衷！">
  <meta name="author" content="2cloudlab">
  <meta name="generator" content="Hugo 0.62.1" />
  
  <!-- Mobile Specific Metas -->
  <meta name="format-detection" content="telephone=no">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>DynamoDB Stream</title>
  <link rel="icon" href="https://2cloudlab.com/images/favicon.ico">

  <!-- Twitter Bootstrs CSS -->
  <link rel="stylesheet" href="https://2cloudlab.com/plugins/bootstrap/bootstrap.min.css">
  <!-- Ionicons Fonts Css -->
  <link rel="stylesheet" href="https://2cloudlab.com/plugins/ionicons/ionicons.min.css">
  <!-- animate css -->
  <link rel="stylesheet" href="https://2cloudlab.com/plugins/animate-css/animate.css">
  <!-- Hero area slider css-->
  <link rel="stylesheet" href="https://2cloudlab.com/plugins/slider/slider.css">
  <!-- slick slider -->
  <link rel="stylesheet" href="https://2cloudlab.com/plugins/slick/slick.css">
  <!-- Fancybox -->
  <link rel="stylesheet" href="https://2cloudlab.com/plugins/facncybox/jquery.fancybox.css">
  <!-- hover -->
  <link rel="stylesheet" href="https://2cloudlab.com/plugins/hover/hover-min.css">
  <!-- template main css file -->
  
  <link rel="stylesheet" href="https://2cloudlab.com/css/style.min.css" integrity="" media="screen">
  
  <link rel="stylesheet" href="https://2cloudlab.com/css/syntax.min.css" integrity="" media="screen">
</head><body><section class="top-bar animated-header">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <nav class="navbar navbar-expand-lg navbar-light bg-light">
                    <a class="navbar-brand" href="https://2cloudlab.com/">
                        <img src="https://2cloudlab.com/images/logo.png" alt="logo">
                    </a>
                    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navigation"
                        aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation">
                        <span class="navbar-toggler-icon"></span>
                    </button>

                    <div class="collapse navbar-collapse" id="navigation">
                        <ul class="navbar-nav ml-auto">
                            <li class="nav-item">
                                <a class="nav-link"
                                    href="https://2cloudlab.com/">首页</a>
                            </li>
                            
                            <li class="nav-item">
                                <a class="nav-link" href="https://2cloudlab.com/about">关于</a>
                            </li>
                            
                            <li class="nav-item">
                                <a class="nav-link" href="https://2cloudlab.com/service">服务</a>
                            </li>
                            
                            <li class="nav-item">
                                <a class="nav-link" href="https://2cloudlab.com/price">价格</a>
                            </li>
                            
                            <li class="nav-item">
                                <a class="nav-link" href="https://2cloudlab.com/blog">博客</a>
                            </li>
                            
                            <li class="nav-item">
                                <a class="nav-link" href="https://2cloudlab.com/nosql">NoSQL</a>
                            </li>
                            
                            <li class="nav-item">
                                <a class="nav-link" href="https://2cloudlab.com/contact">联系我们</a>
                            </li>
                            
                    </div>
                </nav>
            </div>
        </div>
    </div>
</section>

<section class="global-page-header">
    <div class="container post-container">
        <div class="row">
            <div class="col-md-12">
                <div class="block">
                    <h2>DynamoDB Stream</h2>
                    <div class="portfolio-meta">
                        <span>2020-03-05</span>|
                        <span class="ion-pricetags"></span>
                        <span>
                            NoSQL, DynamoDB, Data-Intensive
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<style type="text/css">
    @media (min-width: 1200px) {
        .post-container {
            max-width: 800px;
        }
    }

    img {
        max-width: 100%;
        max-height: 100%;
        display: block;
        margin: auto;
    }
</style>

<section class="single-post">
    <div class="container post-container">
        <div class="row">
            <div class="col-md-12">
                
                <div class="post-img">
                    <img class="img-fluid lazy" alt="" data-src="https://2cloudlab.com/images/blog/dynamodb-streams.png">
                </div>
                
                <div class="post-content">
                    <p>DynamoDB的表能够存储大量的数据，为了提高查找性能，研发人员通常会将关联但不同的数据实体（比如User和Order）集中存放在一台服务器上，这就导致表中的数据关系难以理解！如果直接基于该表来分析其中的数据，则分析工作将会变得困难起来，除此之外，也会影响终端用户的用户体验（分析任务会占用该表的读写单元）。为了使分析工作变得简单，则需要将表中的数据导入到其它分析系统，最终依赖其它分析系统来分析数据。将数据导出到其它系统主要有2种办法，它们分别是：1.遍历整张表，并将每一项数据写入到其它系统；2.表中的数据每变更一次，则将变更写入到其它系统。前者不适用于数据量庞大的情景，而后者可以很好地避开处理大量数据，但需要借助<strong>DynamoDB Stream</strong>功能来实现。</p>
<p><strong>DynamoDB Stream</strong>是DynamoDB提供的一个功能，现实世界里有许多场景会使用到它，这些场景有：</p>
<ul>
<li>同步不同区域的数据。比如你的业务分布在中国和美国，那么你需要将美国的数据同步到中国，反之亦然。此时你需要借助DynamoDB Stream来实现数据同步，最终确保中国用户与美国用户访问的数据是一致的。</li>
<li>发送消息。比如你的App有一个用户注册功能，每当一个新用户注册时，你需要向新用户发送一封表示欢迎的邮件通知。此时你需要DynamoDB Stream的通知机制来触发分发邮件的服务。</li>
<li>索引数据。DynamoDB不适合<strong>全文搜索</strong>，因此如果你想要搜索表中的数据，那么最好的办法是将表中的数据快速同步到<strong>Elastic Search</strong>服务或者<a href="https://www.algolia.com/">algolia</a>里，最终通过这些服务来搜索数据。为了能够快速地将数据更新到搜索系统，那么则需要DynamoDB Stream。</li>
<li>聚合或统计数据。有时你想快速得到一些统计信息，比如某个区域的总销量，每家门店每个月所需的成本等等。那么你可以使用DynamoDB Stream来聚合这些数据。</li>
</ul>
<p>为了实现以上提到的应用场景，则需要了解DynamoDB Stream内部的逻辑以及它与其它服务的关系。<a href="https://2cloudlab.com/nosql/dynamodb-streams/">这篇文章</a>将从以下几个方面来讲解DynamoDB Stream：</p>
<ol>
<li>DynamoDB Stream的构成以及其周边服务</li>
<li>使用DynamoDB Stream的注意事项</li>
<li>基于DynamoDB Stream的设计模式</li>
<li>参考</li>
</ol>
<h2 id="dynamodb-stream">DynamoDB Stream的构成以及其周边服务</h2>
<p>DynamoDB Stream是DynamoDB服务所提供的一个功能，它需要结合DynamoDB Table来使用。开启DynamoDB Stream功能的Table能集成其它服务，最终能够延伸DynamoDB的功能（比如，使用Elastic Search来检索表中的数据，并提供全文搜索功能！）。下图展示了DynamoDB Stream与其它服务的关系：</p>
<p><img class="lazy" data-src="https://2cloudlab.com/images/blog/DynamoDB-Stream.png" alt=""  /></p>
<p>上图涉及到DynamoDB Stream的工作流程是：</p>
<ol>
<li>Producers将向表中修改数据，包括添加数据，修改已有数据，删除数据等。这些操作均是基于HTTPS协议来发起的。</li>
<li>DynamoDB将修改之后的数据发送给DynamoDB Stream（向每个Shard中写入数据的速率最多是1MB/S），数据在DynamoDB中只能存放24小时，在这之后，数据将自动从DynamoDB Stream中移除。</li>
<li>每个Consumer从对应的Shard中批量读取记录，每次最多能读取1000条记录或者每秒最多能读取2MB数据，只要有一个条件满足，则读取数据的操作将停止并将读到的数据返回给Consumer。读取操作是基于HTTPS协议来发起的。</li>
</ol>
<p>上图涉及到DynamoDB Stream的内部逻辑以及外部交互：</p>
<p>研发人员在使用DynamoDB服务时，需要创建表（Table），每一张表其内部又根据数据量划分了好几个分区（如上图的Partition A，Partition B，Partition C）。每一个分区其实会分布于不同的服务器上。</p>
<p>如果在该表上启用了DynamoDB Stream，那么这个Stream会根据分区数量来创建Shard（如上图有3个Shard）。每一个分区中修改的数据只会发送到对应的Shard上，并且是有序的。每一个Shard里的数据（如上图的Record），其生命周期是24小时，在这之后，该数据项自动移除。</p>
<p>DynamoDB Stream只允许使用者（也就是上图的Consumers）从中批量读取数据，其它操作，比如删除其中的数据项或者修改其中的数据项是禁止的。DynamoDB Stream的吞吐量（MB/S）受到Shard的限制，Shard的数量越多，则其吞吐量越大（每个Shard的吞吐量是2MB/S，每个Consumer每秒最多能读取1MB的数据）。每个Consumer一次最多能从对应的Shard中读取1000条数据（Record）。每个Shard最多同时被2个Consumers来使用，超过这个数量，则会导致读取失败，这一点使得DynamoDB Stream无法直接支持超过2个以上的服务（比如，无法同时支持新用户注册收到欢迎邮件，将数据导出到其它分析系统，检索DynamoDB中的数据等）。</p>
<p>上图使用了AWS Lambda服务作为DynamoDB Stream的Consumers。研发人员只需要创建一个Lambda Function，然后将该Function的触发器设置成DynamoDB，就能接收DynamoDB Stream的通知了。当每个Shard里有新的数据时，Lambda服务会根据该函数的设置（比如最多一次取10000个Records）读取Records（如果Shard里有100万条数据，每1000条的数据量是0.8MB&lt;1MB，那么Lambda服务会调用10次<a href="https://docs.aws.amazon.com/amazondynamodb/latest/APIReference/API_streams_GetRecords.html">GetRecords</a>操作，并得到8MB的数据，但是由于Lambda Function的request PayLoad最大是6MB，因此，此时调用Lambda Function时会引发异常。），然后调用Function实例，并将读取到的Records批量传递给Function，由Function决定发送给哪些下游服务，如果这些批量数据均处理成功，那么Lambda服务将继续从对应的Shard中读取下一批Record，直到对应的Shard中没有新的数据。</p>
<p>除了使用Lambda Function，还可以使用EC2，并运行<a href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/Streams.KCLAdapter.html">KCL和DynamoDB Streams Kinesis Adapter</a>应用来读取数据，如下图所示：</p>
<p><img class="lazy" data-src="https://2cloudlab.com/images/blog/DynamoDB-stream-with-kcl.png" alt=""  /></p>
<p>与Lambda Function作为Consumers不同，KCL Workers需要运行在服务器上（比如EC2或Kubernetes的节点上），并且需要研发人员考虑规模化的问题，比如决定运行几个Workers等。除此之外，研发人员还要基于<a href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/Streams.KCLAdapter.html">KCL和DynamoDB Streams Kinesis Adapter</a>编写数据读取应用。</p>
<h2 id="dynamodb-stream-1">使用DynamoDB Stream的注意事项</h2>
<p>DynamoDB Stream能够捕获DynamoDB Table中变化的数据，并保留24小时。每项数据（Record）按照作用到表上的时间先后进入到Stream中的某一个Shard（根据该Record的Key来选择Shard），而且同一Record只会出现一次而不会出现多次，这些特性使得DynamoDB Stream能够用于同步数据（比如将不同区域的数据同步成一致的状态）。</p>
<p>DynamoDB Stream不会占用DynamoDB Table的读写单元（WCU和RCU），而是直接使用了类似于DB中的<a href="https://en.wikipedia.org/wiki/Transaction_log">Transactions Log</a>结构来获取变更的数据，因此其它服务从DynamoDB Stream读取数据时，不会影响其关联<strong>表</strong>（Table）的性能。</p>
<p>DynamoDB Stream会根据DynamoDB Table中分区（Partition）的数量创建相同数量的Shards，每一个Shard都会有一些限制，比如，调用GetRecords接口最多能返回1000条Record，返回的数据量最多是1MB。因此，当需要将数据从DynamoDB Stream中发送到另外一个下游服务，则需要考虑下游服务的写入数据的速率。比如，从DynamoDB Stream中读取数据的速率是10M/S，而下游Elastic Search只能支撑最大的写入数据的速率是1M/S，那么此时需要调整读取数据的应用（Lambda Function或KCL Worker）或者提高Elastic Search写入数据的速率，以便上下游的服务的数据流转速率是匹配的。</p>
<p>在DynamoDB Stream内部，每一个Shard，最多能同时支持2个Consumers，如果有2个以上Consumer来读取同一个Shard，那么很有可能会引发数据读取失败的错误。因此要想规模化DynamoDB Stream的读取数据的操作，则首先要确保其关联表中的数据是均匀分布的，其次要将Consumers均匀分配给不同的Shards，最后要确保每一个Shard不能同时被2个以上的Consumers占用。</p>
<p>对于需要DynamoDB Stream同步数据的应用场景，如果在同步过程中出现了错误，那么需要将已经执行成功的数据回退并重新处理整批数据。原因在于数据的最终状态依赖于DB中Transactions的次序，而DynamoDB Stream中变更的数据，其次序与DB中Transactions的次序是一致的。假设我们向DynamoDB Table中新增一项数据（Record，其ID是123），接着再进行修改，之后再删除，此时DynamoDB Table的Transaction Log里会出现3个Transactions，分别对应Insert，Update和Delete操作以及相关的数据，而这些操作所产生的Records会以同样的次序出现在DynamoDB Stream里，如下所示：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">Records<span class="o">[</span>
    <span class="o">{</span>
        <span class="s2">&#34;EventName&#34;</span>:<span class="s2">&#34;Insert&#34;</span>,
        <span class="s2">&#34;ID&#34;</span>:<span class="s2">&#34;123&#34;</span>,
        <span class="s2">&#34;Name&#34;</span>:<span class="s2">&#34;2cloudlab.com&#34;</span>
    <span class="o">}</span>,
    <span class="o">{</span>
        <span class="s2">&#34;EventName&#34;</span>:<span class="s2">&#34;Update&#34;</span>,
        <span class="s2">&#34;ID&#34;</span>:<span class="s2">&#34;123&#34;</span>,
        <span class="s2">&#34;Name&#34;</span>:<span class="s2">&#34;https://2cloudlab.com&#34;</span>
    <span class="o">}</span>,
    <span class="o">{</span>
        <span class="s2">&#34;EventName&#34;</span>:<span class="s2">&#34;Delete&#34;</span>,
        <span class="s2">&#34;ID&#34;</span>:<span class="s2">&#34;123&#34;</span>,
        <span class="s2">&#34;Name&#34;</span>:<span class="s2">&#34;https://2cloudlab.com&#34;</span>
    <span class="o">}</span>
<span class="o">]</span>
</code></pre></div><p>假设，在一次同步过程中出错了，比如处理以下数据时出错了：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="o">{</span>
    <span class="s2">&#34;EventName&#34;</span>:<span class="s2">&#34;Insert&#34;</span>,
    <span class="s2">&#34;ID&#34;</span>:<span class="s2">&#34;123&#34;</span>,
    <span class="s2">&#34;Name&#34;</span>:<span class="s2">&#34;2cloudlab.com&#34;</span>
<span class="o">}</span>
</code></pre></div><p>如果同步程序忽略错误而继续处理后续的数据，比如：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="o">{</span>
    <span class="s2">&#34;EventName&#34;</span>:<span class="s2">&#34;Update&#34;</span>,
    <span class="s2">&#34;ID&#34;</span>:<span class="s2">&#34;123&#34;</span>,
    <span class="s2">&#34;Name&#34;</span>:<span class="s2">&#34;https://2cloudlab.com&#34;</span>
<span class="o">}</span>
</code></pre></div><p>由于目标数据库没有ID为123的数据，因此这次更新目标数据库的操作将失败。将DynamoDB Stream中的数据发送到其它系统这个过程会伴随着错误，因此研发人员需要根据不同的应用场景设计出错误处理方案。接下来，让我们看看如何基于DynamoDB Stream来设计健壮的事件驱动型系统。</p>
<h2 id="dynamodb-stream-2">基于DynamoDB Stream的设计模式</h2>
<p>DynamoDB Stream非常适合于事件驱动型架构（<a href="https://en.wikipedia.org/wiki/Event-driven_architecture">event-driven architecture</a>）。</p>
<h2 id="heading">参考</h2>
<ul>
<li><a href="https://aws.amazon.com/blogs/database/how-to-perform-ordered-data-replication-between-applications-by-using-amazon-dynamodb-streams/">How to perform ordered data replication between applications by using Amazon DynamoDB Streams</a></li>
<li><a href="https://medium.com/realtime-data-streaming/data-streaming-from-dynamodb-scaling-it-up-8273d23295c">DynamoDB Stream Processing: Scaling it up</a></li>
<li><a href="https://medium.com/realtime-data-streaming/data-streaming-from-dynamodb-to-elasticsearch-eb2381446f43">DynamoDB Stream Processing</a></li>
<li><a href="https://www.serverless.com/blog/event-driven-architecture-dynamodb/">Event-driven processing with Serverless and DynamoDB streams</a></li>
<li><a href="https://www.serverless.com/blog/stream-based-challenges-and-patterns/">Challenges and patterns for building event-driven architectures</a></li>
<li><a href="https://aws.amazon.com/blogs/database/dynamodb-streams-use-cases-and-design-patterns/">DynamoDB Streams Use Cases and Design Patterns</a></li>
</ul>

                </div>
            </div>
        </div>
    </div>
</section>

<section>
    <script src="https://utteranc.es/client.js" repo="2cloudlab/comments" issue-term="pathname" theme="github-light"
        crossorigin="anonymous" async>

        </script>
</section>


<!-- Call To Action Section Start -->
<section id="call-to-action">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <div class="block">
                    <h2 class="title wow fadeInDown" data-wow-delay=".3s" data-wow-duration="500ms">听起来还不错 ？</h1>
                    <p class="wow fadeInDown" data-wow-delay=".5s" data-wow-duration="500ms">如果你所在的企业遇到了以下问题：<br> 研发流程混乱不堪或者效率低下、经历了持续上升的运维成本、无法及时向用户发布新的服务或产品以及想使用云计算技术但缺乏经验！<br>那么，请毫不犹疑地</p>
                    <a href="/contact" class="btn btn-default btn-contact wow fadeInDown" data-wow-delay=".7s" data-wow-duration="500ms">联系我们</a>
                </div>
            </div>

        </div>
    </div>
</section>
<!-- Call To Action Section End -->


<!-- Footer Section Start -->
<footer id="footer">
    <div class="container">
        <div class="row content-justify-between">
            <div class="col-md-8 col-12 text-center text-lg-left text-md-left">
                <p class="copyright">版权所有©:
                    <span>
                        <script>document.write(new Date().getFullYear())</script>
                    </span> 上海漫步云端科技有限公司
                    <a href="https://2cloudlab.com/" target="_blank">2cloudlab.com</a>.
                    <br> 地址：上海市浦东区浦东南路 999 号新梅联合广场 1 期 32 层
                    <br>
                    邮箱：<a href="mailto:support@2cloudlab.com">support@2cloudlab.com</a>
                </p>
            </div>
            <div class="col-md-4 col-12">
                <!-- Social Media -->
                <ul class="social text-center text-md-right text-lg-right">
                    
                    <li><a href="https://github.com/2cloudlab"><i class="ion-social-github"></i></a></li>
                    
                    <li><a href="https://www.linkedin.com/company/2cloudlab-com"><i class="ion-social-linkedin"></i></a></li>
                    
                </ul>
            </div>
        </div>
    </div>
</footer>
<!-- footer section end -->

<!-- jquery -->
<script src="https://2cloudlab.com/plugins/jQurey/jquery.min.js"></script>
<!-- Form Validation -->
<script src="https://2cloudlab.com/plugins/form-validation/jquery.form.js"></script>
<script src="https://2cloudlab.com/plugins/form-validation/jquery.validate.min.js"></script>
<!-- slick slider -->
<script src="https://2cloudlab.com/plugins/slick/slick.min.js"></script>
<!-- bootstrap js -->
<script src="https://2cloudlab.com/plugins/bootstrap/bootstrap.min.js"></script>
<!-- wow js -->
<script src="https://2cloudlab.com/plugins/wow-js/wow.min.js"></script>
<!-- slider js -->
<script src="https://2cloudlab.com/plugins/slider/slider.js"></script>
<!-- Fancybox -->
<script src="https://2cloudlab.com/plugins/facncybox/jquery.fancybox.js"></script>
<!-- template main js -->

<script src="https://2cloudlab.com/js/script.min.js"></script>
<!-- google analitycs -->
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-171018621-1', 'auto');
    ga('send', 'pageview');
</script></body>
</html>